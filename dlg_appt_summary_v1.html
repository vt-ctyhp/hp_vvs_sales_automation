<!doctype html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    :root { --fg:#111; --muted:#666; --line:#e6e6e6; --bg:#fff; --chip:#f2f2f2; }
    body { font: 13px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--fg); margin:16px; }
    h2 { margin:0 0 6px; }
    .sub { color:var(--muted); margin: 0 0 14px; }

    .row { display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size:12px; color:#333; }
    input[type="date"] { padding:6px 8px; border:1px solid var(--line); border-radius:8px; min-width: 160px; }
    .btn {
      border:1px solid var(--line); background:#000; color:#fff; padding:8px 12px; border-radius:10px;
      cursor:pointer; font-weight:600;
    }
    .btn.secondary { background:#f8f8f8; color:#111; }
    .btn:disabled { opacity:.6; cursor:default; }

    .meta { margin-top:12px; display:flex; gap:10px; align-items:center; color:var(--muted); }
    .chip { background:var(--chip); padding:4px 8px; border-radius:999px; font-size:12px; }

    .table-wrap { margin-top:14px; border:1px solid var(--line); border-radius:12px; overflow:auto; max-width:100%; }
    table { width:100%; border-collapse:collapse; font-size:12.5px; }
    table { min-width: 1600px; }  /* tune as desired */

    thead th {
      text-align:left; background:#fafafa; border-bottom:1px solid var(--line); padding:8px 8px; position:sticky; top:0; z-index:1;
    }
    tbody td { border-bottom:1px solid #f3f3f3; padding:7px 8px; vertical-align:top; }
    tbody tr:hover { background:#fdfdfd; }
    .right { text-align:right; }
    .muted { color:var(--muted); }
    .controls { display:flex; gap:8px; margin-left:auto; }
    .footer { display:flex; align-items:center; gap:10px; margin-top:10px; color:var(--muted); }

    .spinner { display:none; }
    .spinner.on { display:inline-block; width:14px; height:14px; border:2px solid #bbb; border-top-color:#111; border-radius:50%;
                  animation:spin .8s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .empty {
      text-align:center; padding:30px 10px; color:var(--muted);
      border:1px dashed var(--line); border-radius:10px; margin-top:12px;
    }
    .dropdown { position: relative; }
    .dd-toggle { display:flex; align-items:center; justify-content:space-between; min-width:220px; }
    .caret { margin-left:8px; font-size:12px; }
    .dd-panel {
      position:absolute; top:calc(100% + 6px); left:0; min-width:260px; max-height:260px; overflow:auto;
      background:#fff; border:1px solid var(--line); border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,.08);
      padding:10px; display:none; z-index:2000;
    }
    .dd-panel.open { display:block; }
    .dd-actions { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .dd-list { display:flex; flex-direction:column; gap:6px; padding-right:4px; }
    .dd-item { display:flex; align-items:center; gap:8px; }
    .dd-footer { display:flex; justify-content:flex-end; margin-top:10px; }
    .link { background:none; border:none; color:#0070f3; cursor:pointer; padding:0; }

    /* Top filter area: 3 columns + buttons */
    .filters-grid {
      display: grid;
      grid-template-columns:
        minmax(260px, 1.2fr)  /* Brand */
        minmax(220px, 0.9fr)  /* Start */
        minmax(220px, 0.9fr)  /* End */
        auto;                 /* Buttons */
      column-gap: 14px;
      row-gap: 8px;
      align-items: end;       /* bottoms line up nicely */
    }

    /* Keep buttons aligned to the bottom-right of the row */
    .filters-grid .controls {
      justify-self: end;
      align-self: end;
      display: flex;
      gap: 8px;
    }

    /* Put the Brand hint directly under the Brand column */
    .filters-grid .hint {
      grid-column: 1 / 2;
      margin-top: 2px;
    }

    /* Make the Brand button height match date inputs */
    .dd-toggle,
    input[type="date"] {
      height: 36px;
      padding: 6px 10px;
      border-radius: 8px;
    }

    /* Responsive: stack on narrow screens */
    @media (max-width: 900px) {
      .filters-grid {
        grid-template-columns: 1fr;
        align-items: start;
      }
      .filters-grid .controls {
        justify-self: start;
      }
      .filters-grid .hint {
        grid-column: 1;
      }
    }

  </style>
</head>
<body>
  <p class="sub">Pick a date range to list concise appointment details from <b>00_Master Appointments</b>.</p>

  <div class="filters-grid">
    <!-- Brand -->
    <div class="field field--brand">
      <label for="brandToggle">Brand (optional)</label>
      <div class="dropdown" id="brandDropdown">
        <button type="button" class="btn secondary dd-toggle" id="brandToggle">
          <span id="brandSummary">All brands</span>
          <span class="caret">▾</span>
        </button>
        <div class="dd-panel" id="brandPanel" aria-hidden="true">
          <div class="dd-actions">
            <button type="button" class="link" id="brandSelectAll">Select all</button>
            <span>•</span>
            <button type="button" class="link" id="brandClear">Clear</button>
          </div>
          <div class="dd-list" id="brandList"></div>
          <div class="dd-footer">
            <button type="button" class="btn" id="brandApply">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Start date -->
    <div class="field">
      <label for="start">Start date</label>
      <input id="start" type="date">
    </div>

    <!-- End date -->
    <div class="field">
      <label for="end">End date</label>
      <input id="end" type="date">
    </div>

    <!-- Buttons (right side) -->
    <div class="controls">
      <button id="run" class="btn">Run Summary <span id="sp" class="spinner"></span></button>
      <button id="export" class="btn secondary" disabled>Export PDF</button>
    </div>

    <!-- Sales Stage -->
    <div class="field">
      <label for="stageToggle">Sales Stage</label>
      <div class="dropdown">
        <button type="button" class="btn secondary dd-toggle" id="stageToggle">
          <span id="stageSummary">All</span><span class="caret">▾</span>
        </button>
        <div class="dd-panel" id="stagePanel" aria-hidden="true">
          <div class="dd-actions">
            <button type="button" class="link" id="stageSelectAll">Select all</button>
            <span>•</span>
            <button type="button" class="link" id="stageClear">Clear</button>
          </div>
          <div class="dd-list" id="stageList"></div>
          <div class="dd-footer">
            <button type="button" class="btn" id="stageApply">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Conversion -->
    <div class="field">
      <label for="convToggle">Conversion</label>
      <div class="dropdown">
        <button type="button" class="btn secondary dd-toggle" id="convToggle">
          <span id="convSummary">All</span><span class="caret">▾</span>
        </button>
        <div class="dd-panel" id="convPanel" aria-hidden="true">
          <div class="dd-actions">
            <button type="button" class="link" id="convSelectAll">Select all</button>
            <span>•</span>
            <button type="button" class="link" id="convClear">Clear</button>
          </div>
          <div class="dd-list" id="convList"></div>
          <div class="dd-footer">
            <button type="button" class="btn" id="convApply">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Custom Order -->
    <div class="field">
      <label for="coToggle">Custom Order</label>
      <div class="dropdown">
        <button type="button" class="btn secondary dd-toggle" id="coToggle">
          <span id="coSummary">All</span><span class="caret">▾</span>
        </button>
        <div class="dd-panel" id="coPanel" aria-hidden="true">
          <div class="dd-actions">
            <button type="button" class="link" id="coSelectAll">Select all</button>
            <span>•</span>
            <button type="button" class="link" id="coClear">Clear</button>
          </div>
          <div class="dd-list" id="coList"></div>
          <div class="dd-footer">
            <button type="button" class="btn" id="coApply">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Center Stone -->
    <div class="field">
      <label for="csToggle">Center Stone</label>
      <div class="dropdown">
        <button type="button" class="btn secondary dd-toggle" id="csToggle">
          <span id="csSummary">All</span><span class="caret">▾</span>
        </button>
        <div class="dd-panel" id="csPanel" aria-hidden="true">
          <div class="dd-actions">
            <button type="button" class="link" id="csSelectAll">Select all</button>
            <span>•</span>
            <button type="button" class="link" id="csClear">Clear</button>
          </div>
          <div class="dd-list" id="csList"></div>
          <div class="dd-footer">
            <button type="button" class="btn" id="csApply">Apply</button>
          </div>
        </div>
      </div>
    </div>


    <!-- Brand hint under Brand only -->
    <div class="muted hint">Leave empty = all brands</div>

  </div>

  <div class="meta">
    <span id="bounds" class="muted"></span>
    <span id="count" class="chip" style="display:none;"></span>
  </div>

  <div id="result" class="table-wrap" style="display:none;">
    <table id="tbl">
      <thead>
        <tr>
          <th>Visit Date</th>
          <th>RootApptID</th>
          <th>Customer</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Visit Type</th>
          <th>Visit #</th>
          <th>SO#</th>
          <th>Brand</th>
          <th>Assigned Rep</th>
          <th>Assisted Rep</th>
          <th>Sales Stage</th>
          <th>Conversion</th>
          <th>Custom Order</th>
          <th>Center Stone</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="empty" class="empty" style="display:none;">No rows found for the selected range.</div>

  <div class="footer">
    <span class="muted">Tip: Sorts by Visit Date → Brand → RootApptID → Visit #.</span>
  </div>

  <script>
    /* Boot payload injected from server as raw JSON (unescaped). */
    const BOOT = <?!= JSON.stringify(BOOTSTRAP) ?>;

    const el = (id) => document.getElementById(id);
    const $start = el('start');
    const $end = el('end');
    const $run = el('run');
    const $sp = el('sp');
    const $bounds = el('bounds');
    const $result = el('result');
    const $tbody = $result.querySelector('tbody');
    const $count = el('count');
    const $empty = el('empty');
    const $export = el('export');

    let lastRows = [];

    /**
     * Renders the Brand checklist dropdown and wires interactions.
     * @param {string[]} list - array of distinct brand names
     */
    function renderBrandDropdown(list){
      const panel     = document.getElementById('brandPanel');
      const listEl    = document.getElementById('brandList');
      const summary   = document.getElementById('brandSummary');
      const toggleBtn = document.getElementById('brandToggle');
      const selectAll = document.getElementById('brandSelectAll');
      const clearBtn  = document.getElementById('brandClear');
      const applyBtn  = document.getElementById('brandApply');

      // Build option list
      listEl.innerHTML = '';
      (list || []).forEach(b => {
        const id  = 'brand_' + String(b).replace(/\W+/g,'_');
        const row = document.createElement('label');
        row.className = 'dd-item';
        row.innerHTML = `
          <input type="checkbox" class="brandChk" id="${id}" value="${esc(b)}">
          <span>${esc(b)}</span>
        `;
        listEl.appendChild(row);
      });

      // Dropdown open/close helpers
      const open  = () => { panel.classList.add('open');  panel.setAttribute('aria-hidden','false'); };
      const close = () => { panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); };

      // Toggle open/close
      if (toggleBtn) {
        toggleBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          panel.classList.toggle('open');
          panel.setAttribute('aria-hidden', panel.classList.contains('open') ? 'false' : 'true');
        });
      }
      // Click outside closes
      document.addEventListener('click', (e) => {
        if (!panel.contains(e.target) && e.target !== toggleBtn) close();
      });

      // Bulk actions
      if (selectAll) {
        selectAll.addEventListener('click', () => {
          brandState = new Set(list || []);
          listEl.querySelectorAll('.brandChk').forEach(cb => { cb.checked = true; });
          updateSummary();
        });
      }
      if (clearBtn) {
        clearBtn.addEventListener('click', () => {
          brandState.clear();
          listEl.querySelectorAll('.brandChk').forEach(cb => { cb.checked = false; });
          updateSummary();
        });
      }
      if (applyBtn) {
        applyBtn.addEventListener('click', () => close());
      }

      // Per‑checkbox changes
      listEl.addEventListener('change', (ev) => {
        const t = ev.target;
        if (!(t && t.classList && t.classList.contains('brandChk'))) return;
        const val = t.value;
        if (t.checked) brandState.add(val); else brandState.delete(val);
        updateSummary();
      });

      // Update the summary label under the toggle
      function updateSummary(){
        if (!brandState.size) summary.textContent = 'All brands';
        else if (brandState.size === 1) summary.textContent = [...brandState][0];
        else summary.textContent = `${brandState.size} selected`;
      }

      // Expose a getter for the current selection (used when running/exporting)
      window.__getSelectedBrands = () => [...brandState];

      // Initial summary state
      updateSummary();

      // OPTIONAL: default to "all selected" (uncomment to enable)
      brandState = new Set(list || []);
      listEl.querySelectorAll('.brandChk').forEach(cb => { cb.checked = true; });
      updateSummary();
    }

    // ---- Multi-filter state (Brand, Stage, Conversion, Custom Order, Center Stone) ----
    const FILTER = {
      brands:       new Set(),
      stages:       new Set(),
      conversions:  new Set(),
      customOrders: new Set(),
      centerStones: new Set()
    };

    /**
     * Generic checklist dropdown renderer.
     * Expects elements with IDs: ${prefix}Toggle, ${prefix}Panel, ${prefix}List,
     * ${prefix}SelectAll, ${prefix}Clear, ${prefix}Apply, ${prefix}Summary.
     * Example: prefix='brand' -> brandToggle, brandPanel, ...
     */
    function renderChecklist(prefix, options, stateSet) {
      const panel   = document.getElementById(prefix + 'Panel');
      const listEl  = document.getElementById(prefix + 'List');
      const toggle  = document.getElementById(prefix + 'Toggle');
      const summary = document.getElementById(prefix + 'Summary');

      // Guard if markup not found
      if (!panel || !listEl || !toggle || !summary) return;

      // Build options
      listEl.innerHTML = '';
      (options || []).forEach(opt => {
        const id  = `${prefix}_${String(opt).replace(/\W+/g,'_')}`;
        const row = document.createElement('label');
        row.className = 'dd-item';
        row.innerHTML = `<input type="checkbox" class="${prefix}Chk" id="${id}" value="${esc(opt)}"><span>${esc(opt)}</span>`;
        listEl.appendChild(row);
      });

      // Open/close
      const open  = () => { panel.classList.add('open');  panel.setAttribute('aria-hidden','false'); };
      const close = () => { panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); };

      toggle.addEventListener('click', (e) => {
        e.stopPropagation(); // IMPORTANT so document click doesn’t immediately close it
        panel.classList.toggle('open');
        panel.setAttribute('aria-hidden', panel.classList.contains('open') ? 'false' : 'true');
      });
      document.addEventListener('click', (e) => {
        if (!panel.contains(e.target) && e.target !== toggle) close();
      });

      // Bulk actions
      const selAll = document.getElementById(prefix + 'SelectAll');
      const clr    = document.getElementById(prefix + 'Clear');
      const apply  = document.getElementById(prefix + 'Apply');

      selAll?.addEventListener('click', () => {
        stateSet.clear();
        (options || []).forEach(v => stateSet.add(v));
        listEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
        updateSummary();
      });
      clr?.addEventListener('click', () => {
        stateSet.clear();
        listEl.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateSummary();
      });
      apply?.addEventListener('click', () => close());

      // Track changes
      listEl.addEventListener('change', (ev) => {
        const t = ev.target;
        if (!t || t.type !== 'checkbox') return;
        if (t.checked) stateSet.add(t.value); else stateSet.delete(t.value);
        updateSummary();
      });

      function updateSummary(){
        if (!stateSet.size) summary.textContent = (prefix === 'brand') ? 'All brands' : 'All';
        else if (stateSet.size === 1) summary.textContent = [...stateSet][0];
        else summary.textContent = `${stateSet.size} selected`;
      }
      updateSummary();
    }

    // Return current selection as arrays (used by Run/Export)
    function getSelectedFilters() {
      return {
        brands:       [...FILTER.brands],
        stages:       [...FILTER.stages],
        conversions:  [...FILTER.conversions],
        customOrders: [...FILTER.customOrders],
        centerStones: [...FILTER.centerStones]
      };
    }


    (function init(){
      try {
        // Guard: bootstrap failed → show reason, disable actions
        if (!BOOT || !BOOT.ok) {
          $bounds.textContent = 'Error: ' + (BOOT && BOOT.error ? BOOT.error : 'Failed to load.');
          $run.disabled = true;
          $export.disabled = true;
          return;
        }

        // Dates
        $start.value = BOOT.defStartISO || '';
        $end.value   = BOOT.defEndISO   || '';
        if (BOOT.minISO) { $start.min = BOOT.minISO; $end.min = BOOT.minISO; }
        if (BOOT.maxISO) { $start.max = BOOT.maxISO; $end.max = BOOT.maxISO; }

        // Bounds/meta line
        const rows = (typeof BOOT.rowCount === 'number') ? BOOT.rowCount : 0;
        $bounds.textContent = `Data bounds: ${BOOT.minISO || ''} → ${BOOT.maxISO || ''} (${rows} rows)`;

        // Render dropdowns
        renderChecklist('brand', BOOT.brands        || [], FILTER.brands);
        renderChecklist('stage', BOOT.stages        || [], FILTER.stages);
        renderChecklist('conv',  BOOT.conversions   || [], FILTER.conversions);
        renderChecklist('co',    BOOT.customOrders  || [], FILTER.customOrders);
        renderChecklist('cs',    BOOT.centerStones  || [], FILTER.centerStones);
      } catch (e) {
        $bounds.textContent = 'Error: Failed to load.';
        $run.disabled = true;
        $export.disabled = true;
      }
    })();


    $run.addEventListener('click', () => {
      const s = $start.value;
      const e = $end.value;
      if (!s || !e) return alert('Please select both start and end dates.');
      if (s > e) return alert('Start date must be on or before end date.');

      setBusy(true);
      google.script.run
        .withSuccessHandler((res) => {
          setBusy(false);
          if (!res || !res.ok) {
            alert(res && res.error ? res.error : 'Failed to run summary.');
            return;
          }
          lastRows = res.rows || [];
          render(lastRows);
        })
        .withFailureHandler((err) => {
          setBusy(false);
          alert(err && err.message ? err.message : 'Request failed.');
        })
        .as_runAppointmentSummary(s, e, getSelectedFilters());
    });

    $export.addEventListener('click', () => {
      const s = $start.value;
      const e = $end.value;
      if (!lastRows || !lastRows.length) return alert('Nothing to export for the selected range.');
      if (!s || !e) return alert('Please select both start and end dates.');

      const filters = getSelectedFilters();

      setBusy(true);
      google.script.run
        .withSuccessHandler((res) => {
          setBusy(false);
          if (!res || !res.ok) {
            alert(res && res.error ? res.error : 'Failed to generate PDF.');
            return;
          }
          downloadBase64Pdf(res.fileName, res.bytesBase64, res.mimeType || 'application/pdf');
        })
        .withFailureHandler((err) => {
          setBusy(false);
          alert(err && err.message ? err.message : 'Request failed.');
        })
        .as_exportAppointmentSummaryPdf(s, e, filters);
    });


    function hMap(h) {
      return ({
        VisitDate:'VisitDateISO',
        RootApptID:'RootApptID',
        Customer:'Customer',
        Phone:'Phone',
        Email:'Email',
        VisitType:'VisitType',
        VisitNum:'VisitNum',
        SO:'SO',
        Brand:'Brand',
        AssignedRep:'AssignedRep',
        AssistedRep:'AssistedRep',
        SalesStage:'SalesStage',
        Conversion:'Conversion',
        CustomOrder:'CustomOrder',
        CenterStone:'CenterStone'
      })[h];
    }

    function setBusy(on){
      $run.disabled = on;
      $sp.className = 'spinner' + (on ? ' on' : '');
    }

    function render(rows){
      $tbody.innerHTML = '';
      $count.style.display = '';
      $count.textContent = `${rows.length} rows`;

      if (!rows.length) {
        $result.style.display = 'none';
        $empty.style.display = '';
        $export.disabled = true;
        return;
      }
      $empty.style.display = 'none';
      $result.style.display = '';

      const frag = document.createDocumentFragment();
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(r.VisitDateISO)}</td>
          <td>${esc(r.RootApptID)}</td>
          <td>${esc(r.Customer)}</td>
          <td>${esc(r.Phone)}</td>
          <td>${esc(r.Email)}</td>
          <td>${esc(r.VisitType)}</td>
          <td class="right">${esc(r.VisitNum)}</td>
          <td>${esc(r.SO)}</td>
          <td>${esc(r.Brand)}</td>
          <td>${esc(r.AssignedRep)}</td>
          <td>${esc(r.AssistedRep)}</td>
          <td>${esc(r.SalesStage)}</td>
          <td>${esc(r.Conversion)}</td>
          <td>${esc(r.CustomOrder)}</td>
          <td>${esc(r.CenterStone)}</td>
        `;
        frag.appendChild(tr);
      });
      $tbody.appendChild(frag);
      $export.disabled = false;
    }

    function esc(s){
      return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function csvCell(v){
      const s = String(v ?? '');
      if (/[",\r\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    function downloadBase64Pdf(fileName, b64, mime) {
      const byteChars = atob(b64);
      const byteArr = new Uint8Array(byteChars.length);
      for (let i = 0; i < byteChars.length; i++) byteArr[i] = byteChars.charCodeAt(i);
      const blob = new Blob([byteArr], { type: mime || 'application/pdf' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName || 'appointment_summary.pdf';
      document.body.appendChild(a);
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
    }

  </script>
</body>
</html>
