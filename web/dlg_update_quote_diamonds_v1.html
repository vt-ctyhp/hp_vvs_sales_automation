<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="utf-8">
  <style>
    body { font:13px/1.35 Arial, Helvetica, sans-serif; margin:0; color:#222; }
    header { padding:14px 18px; border-bottom:1px solid #e5e5e5; background:#fafafa; }
    h1 { font-size:16px; margin:0 0 6px; }
    .chip { display:inline-flex; align-items:center; padding:3px 8px; border-radius:12px; background:#f0f3f7; border:1px solid #e3e8ee; font-size:12px; margin-right:6px; }
    .muted{color:#666;}
    .sticky { position: sticky; top: 0; z-index: 3; background:#fafafa; border-bottom:1px solid #eee; padding:10px 18px; }
    .btn { border:1px solid #d0d7de; background:#fff; padding:6px 10px; border-radius:6px; cursor:pointer; }
    .btn.primary { background:#0b5cff; border-color:#0b5cff; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .wrap { padding:0 18px 18px; }
    table { width:100%; border-collapse:collapse; font-size:12px; }
    th, td { border-bottom:1px solid #f0f0f0; padding:6px; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:72px; z-index:2; }
    .group { background:#f7f9fc; font-weight:600; }
    .pill { display:inline-block; padding:2px 6px; border-radius:10px; border:1px solid #e5e5e5; background:#f4f7fb; margin-right:4px; }
  </style>
</head>
<body>

<header>
  <h1>ðŸ§¾ Update Quotation â€” Diamonds</h1>
  <span class="chip">Customer: <b id="cust">â€”</b></span>
  <span class="chip">Visit: <b id="visit">â€”</b></span>
  <span class="chip">Company: <b id="brand">â€”</b></span>
  <span class="chip">Rep: <b id="rep">â€”</b></span>
  <span class="chip">RootApptID: <b id="root">â€”</b></span>
  <span class="chip muted" id="qchip">Quotation: <a id="qurl" href="#" target="_blank">open</a></span>
  <span class="chip muted">200_: <a id="file" href="#" target="_blank">open workbook</a> <span class="muted" id="tab"></span></span>
</header>

<div class="sticky">
  <button id="btnSave" class="btn primary" disabled>Send to Quotation (0)</button>
  <span id="hint" class="muted" style="margin-left:8px;">Select at least one stone to enable.</span>
  <span id="msg" class="muted" style="margin-left:16px;"></span>
</div>

<div class="wrap">
  <table id="tbl">
    <thead>
      <tr>
        <th style="width:28px;"><input type="checkbox" id="selAll"></th>
        <th>Vendor</th>
        <th>Type</th>
        <th>Shape</th>
        <th>Carat</th>
        <th>Color</th>
        <th>Clarity</th>
        <th>LAB</th>
        <th>Cert #</th>
        <th>Order Status</th>
        <th>Stone Status</th>
      </tr>
    </thead>
    <tbody id="rows"></tbody>
  </table>
</div>

<script>
  const BOOTSTRAP = <?!= JSON.stringify(bootstrap) ?>;
  const CTX  = BOOTSTRAP.context || {};
  const META = BOOTSTRAP.meta || {};
  let ITEMS  = BOOTSTRAP.items || [];
  const PICKS = new Set();

  // header chips
  document.getElementById('cust').textContent = CTX.customerName || 'â€”';
  document.getElementById('visit').textContent = CTX.visitAt || 'â€”';
  document.getElementById('brand').textContent = CTX.companyBrand || 'â€”';
  document.getElementById('rep').textContent   = CTX.assignedRep || 'â€”';
  document.getElementById('root').textContent  = CTX.rootApptId || 'â€”';
  document.getElementById('file').href         = META.spreadsheetUrl || '#';
  document.getElementById('tab').textContent   = META.tab ? '(Tab: ' + META.tab + ')' : '';
  if (CTX.quotationUrl) {
    document.getElementById('qurl').href = CTX.quotationUrl;
  } else {
    const qc = document.getElementById('qchip');
    qc.title = 'Quotation URL not found on 100_ row (Resolver creates it).';
  }

  function td(t){ const x=document.createElement('td'); x.textContent=t||''; return x; }
  function sync() {
    const n = PICKS.size;
    const btn = document.getElementById('btnSave');
    btn.textContent = 'Send to Quotation (' + n + ')';
    btn.disabled = (n === 0);
    document.getElementById('hint').style.display = n ? 'none' : 'inline';
  }

  function render() {
    const tb = document.getElementById('rows'); tb.innerHTML='';
    let lastGroup = '';
    ITEMS.forEach(it => {
      const grp = (it.customerName || '') + ' â€” ' + (it.rootApptId || '');
      if (grp !== lastGroup) {
        const trg = document.createElement('tr'); trg.className='group';
        const tdg = document.createElement('td'); tdg.colSpan = 11;
        tdg.textContent = grp + (it.apptTimeDate ? '  â€¢  ' + it.apptTimeDate : '');
        trg.appendChild(tdg); tb.appendChild(trg); lastGroup = grp;
      }
      const tr = document.createElement('tr');
      tr.dataset.rowIndex = it.rowIndex;

      // select
      const tdSel = document.createElement('td');
      const cb = document.createElement('input'); cb.type='checkbox';
      cb.onchange = () => { if (cb.checked) PICKS.add(it.rowIndex); else PICKS.delete(it.rowIndex); sync(); };
      tdSel.appendChild(cb); tr.appendChild(tdSel);

      // specs
      tr.appendChild(td(it.vendor));
      tr.appendChild(td(it.stoneType));
      tr.appendChild(td(it.shape));
      tr.appendChild(td(it.carat));
      tr.appendChild(td(it.color));
      tr.appendChild(td(it.clarity));
      tr.appendChild(td(it.lab));
      tr.appendChild(td(it.certNo));
      tr.appendChild(td(it.orderStatus));

      // Stone Status chips
      const tdS = document.createElement('td');
      (String(it.stoneStatus||'').split(/\s*[;|,]\s*|\s*â€¢\s*/g).filter(Boolean)).forEach(tok=>{
        const span=document.createElement('span'); span.className='pill'; span.textContent=tok; tdS.appendChild(span);
      });
      tr.appendChild(tdS);

      tb.appendChild(tr);
    });

    // select all
    const selAll = document.getElementById('selAll');
    selAll.onclick = () => {
      const on = !!selAll.checked;
      PICKS.clear();
      document.querySelectorAll('#rows input[type="checkbox"]').forEach(ch => {
        ch.checked = on;
        if (on) PICKS.add(Number(ch.closest('tr').dataset.rowIndex));
      });
      sync();
    };

    sync();
  }

  // For Step 1: button is disabled; later weâ€™ll wire it to the Quotation writer.
  render();

  // Step 2: Save â†’ server upsert
  document.getElementById('btnSave').addEventListener('click', function () {
    const msg = document.getElementById('msg');
    msg.textContent = '';
    if (!CTX.quotationUrl) {
      alert('Quotation URL is missing on 100_. Please run Resolver first.'); 
      return;
    }
    if (PICKS.size === 0) return;

    const rowIndexes = Array.from(PICKS); // 200_ row indexes
    const payload = {
      rootApptId: CTX.rootApptId,
      quotationUrl: CTX.quotationUrl,
      rowIndexes: rowIndexes
    };

    const btn = document.getElementById('btnSave');
    btn.disabled = true; btn.textContent = 'Updatingâ€¦';

    google.script.run
      .withSuccessHandler(function(res){
        btn.disabled = false;
        btn.textContent = 'Send to Quotation (0)';
        PICKS.clear(); sync();
        if (!res || !res.ok) {
          msg.textContent = 'Unknown error.';
          return;
        }
        msg.textContent = res.message + (res.sheetName ? (' (Sheet: ' + res.sheetName + ')') : '');
      })
      .withFailureHandler(function(err){
        btn.disabled = false;
        btn.textContent = 'Send to Quotation (' + PICKS.size + ')';
        msg.textContent = (err && err.message) ? err.message : String(err);
      })
      .uq_submitUpdateQuotationDiamonds(payload);
  });

</script>
</body>
</html>
